- command: 'toolkit:component-check'
  configuration: [ ]
  tokens: ''
  resources:
    - from: sample-composer.lock
      to: composer.lock
  expectations:
    - contains: |
        Checking Mandatory components.
        ==============================

        [Simulator] Running ./vendor/bin/drush status --format=json
        >  Website not installed, using config/sync/core.extension.yml file.
        >  Config file not found at config/sync/core.extension.yml.
        Package dropsolid_purge is mandatory and is not present on the project.
        Package oe_dashboard_agent is mandatory and is not present on the project.

        Checking Recommended components.
        ================================

        >  This step is in reporting mode, skipping.

        Checking Insecure components.
        =============================

        [Simulator] Running ./vendor/bin/drush pm:security --format=json
        [Simulator] Running composer audit --no-dev --locked --no-scripts --format=json
        >  Insecure components check passed.

        Checking Outdated components.
        =============================

        [Simulator] Running composer outdated --no-dev --locked --direct --minor-only --no-scripts --format=json
        >  Outdated components check passed.

        Checking Abandoned components.
        ==============================

        >  Abandoned components check passed.

        Checking Unsupported components.
        ================================

        [Simulator] Running ./vendor/bin/drush eval "\Drupal::moduleHandler()->loadInclude('update', 'compare.inc') ; echo json_encode(update_calculate_project_data(\Drupal::keyValueExpirable('update_available_releases')->getAll()))"
        Failed to get the available releases.

        Checking evaluation status components.
        ======================================

        The use of drupal/codesnippet:1.8 is restricted. Contact QA Team.
        The use of drupal/github_connect:2.0.0-alpha1 is restricted. Contact QA Team.
        The use of drupal/responsive_tables_filter:1.17 is restricted. Contact QA Team.
        The use of drupal/restui:1.21 is rejected. Contact QA Team.

        Checking dev components in require section.
        ===========================================

        >  Dev components in require section check passed

        Validating composer.
        ====================

        >  Composer validation passed.

        Checking require section for Drush.
        ===================================

        >  Drush require section check passed.

        Results:
        ========

        --------------------------------- --------
        Mandatory module check            failed
        Recommended module check          passed
        Insecure module check             passed
        Outdated module check             passed
        Abandoned module check            passed
        Unsupported module check          passed
        Evaluation module check           failed
        Dev module in require-dev check   passed
        Composer validation check         passed
        --------------------------------- --------

        [ERROR] Failed the components check, please verify the report and update the
        project.

        See the list of packages at

        https://digit-dqa.fpfis.tech.ec.europa.eu/package-reviews.

        ! [NOTE] It is possible to bypass the insecure, outdated, abandoned and
        !        unsupported checks:
        !
        !        - Using commit message to skip Insecure and/or Outdated check:
        !
        !           - Include in the message: [SKIP-INSECURE] and/or [SKIP-OUTDATED]
        !
        !
        !
        !        - Using the configuration in the runner.yml.dist as shown below to
        !        skip Outdated, Abandoned or Unsupported:
        !
        !           toolkit:
        !
        !             components:
        !
        !               outdated:
        !
        !                 check: false
        !
        !               abandoned:
        !
        !                 check: false
        !
        !               unsupported:
        !
        !                 check: false

- command: 'toolkit:component-check'
  configuration:
    toolkit:
      components:
        outdated:
          check: false
        abandoned:
          check: false
        unsupported:
          check: false
  tokens: ''
  resources:
    - from: sample-composer.lock
      to: composer.lock
  expectations:
    - string_contains: Abandoned module check            passed (Skipping)
    - string_contains: Outdated module check             passed (Skipping)
    - string_contains: Unsupported module check          passed (Skipping)

- command: 'toolkit:component-check --test-command'
  configuration:
    toolkit:
      components:
        outdated:
          check: false
  tokens: '[skip_insecure][skip_d9c]'
  resources:
    - from: sample-composer.lock
      to: composer.lock
  expectations:
    - string_contains: Insecure module check             passed (Skipping)
    - string_contains: Outdated module check             passed (Skipping)

- command: 'toolkit:component-check'
  configuration:
    toolkit:
      clean:
        config_file: core.extensions-good.yml
  tokens: ''
  resources:
    - from: sample-core.extensions-good.yml
      to: core.extensions-good.yml
    - from: sample-composer.lock
      to: composer.lock
  expectations:
    - string_contains: Mandatory module check            passed
    - string_contains: Recommended module check          passed
    - string_contains: Insecure module check             passed
    - string_contains: Outdated module check             passed
    - string_contains: Abandoned module check            passed
    - string_contains: Unsupported module check          passed
    - string_contains: Evaluation module check           failed
    - string_contains: Dev module in require-dev check   passed
    - string_contains: Composer validation check         passed

- command: 'toolkit:component-check'
  configuration: [ ]
  tokens: ''
  resources:
    - from: sample-internal-dependency.lock
      to: composer.lock
  expectations:
    - string_contains: Evaluation module check           passed

- command: 'toolkit:component-check'
  configuration: [ ]
  tokens: ''
  resources:
    - file: composer.lock
      content: |
        { "packages": [ { "name": "test/package", "type": "library", "version": "dev-1.0.0" } ] }
  expectations:
    - string_contains: Package test/package:dev-1.0.0 cannot be used in dev version.
    - string_contains: Composer validation check         failed

- command: 'toolkit:component-check'
  configuration: [ ]
  tokens: ''
  resources:
    - file: composer.json
      content: |
        { "extra": { "enable-patching": true } }
    - file: composer.lock
      content: |
        { "packages": [ { "name": "test/package", "type": "library", "version": "1.0.0" } ] }
  expectations:
    - string_contains: The composer property 'extras.enable-patching' cannot be set to true.
    - string_contains: Composer validation check         failed

- command: 'toolkit:component-check'
  configuration: [ ]
  tokens: ''
  resources:
    - file: composer.json
      content: |
        { "extra": { "enable-patching": false } }
    - file: composer.lock
      content: |
        { "packages": [ { "name": "test/package", "type": "library", "version": "1.0.0" } ] }
  expectations:
    - not_string_contains: extras.enable-patching
    - string_contains: Composer validation check         passed
